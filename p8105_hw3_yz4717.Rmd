---
title: "p8105_hw3_yz4717"
author: "Yang Zhao - yz4717"
date: "2023-10-09"
output: github_document
---

```{r}
library(tidyverse)
library(p8105.datasets) 
library(ggplot2)
```

First of all, I import all the needed packages into the environment.

## Question 2

```{r q2_cleaning,warning=FALSE}
data("brfss_smart2010")

dict_resp = c("Poor",
              "Fair",
              "Good",
              "Very good",
              "Excellent")

brfss_df = brfss_smart2010 |> 
  janitor::clean_names() |> 
  filter(topic == "Overall Health" & response %in% dict_resp) |> 
  mutate(
    response,
    response = factor(
      response,
      levels = dict_resp,
      ordered = TRUE)) |> 
  mutate(state = locationabbr,
         county = locationdesc)

brfss_df |> head()
```

First, I imported the data into the environment. The 'clean_names()' function is applied to ensure that the column names of the data frame are clean and standardized. Subsequently, I used the `filter` function to extract rows from the data frame where the 'topic' equal to "Overall Health" and the 'response' column contains any of the predefined health-related responses in the dict_resp . The subsequent mutate function is employed to create a new column called 'response' and converts it into an ordered factor, arranging the levels based on the predefined values in the dict_resp vector. Additionally, another mutate function change the name of `locationabbr` and `locationdesc` variables into `state` and `county` respectively. These operations essentially modifies and filters the data frame, preparing it for analysis and visualization based on the specified health-related responses and related geographical information.

```{r q2_0201}
result_2002 = brfss_df |> 
  filter(year == 2002) |> 
  distinct(state,county)|>  
  count(state) |> 
  filter(n>=7) |> 
  pull(state)

result_2010 = brfss_df |> 
  filter(year == 2010)|> 
  distinct(state,county) |> 
  count(state) |> 
  filter(n>=7) |> 
  pull(state)

```

Then, I used the function `filter` to select the observations in a specific year . Then, I keep only unique rows from the given data by the variable of state and county. And I picked out all the states which appears more than 7 times after counting the state. At last, I use the `pull` functin to show all states which meets the requirement.

Based on the result I have, I have these comments:
* In the year of 2002, there are `r length(result_2002)` states which were observed at 7 or more locations:`r result_2002`.

* In the year of 2010, there are`r length(result_2010)` states  which were observed at 7 or more locations:`r result_2010`.

 The following plot is going to show the average value of the people who gave the excellent response in each state from the year of 2002 to the year of 2010.

```{r q2_output_plot}
excellent = brfss_df |>
  filter(response == "Excellent") |> 
  select(year,state,data_value) |> 
  group_by(state,year) |> 
  summarize(mean = mean(data_value))  

excellent |> 
  ggplot(aes(x = year,y = mean, group = state,color = state)) + 
  geom_line()+
  labs(x = "Year",
    y = "Average",
    title = "Average Within the Given Years In Different States")
```

```{r q2_outpt_boxplot}
ny_distri_df = 
  brfss_df |>  
  filter(year == 2006 | year == 2010 ) |> 
  filter(state == "NY")

ny_distri_df |> head()

ny_distri_df |> 
  ggplot(aes(x=response,y = data_value))+
  geom_boxplot() +
  facet_wrap(.~year)
```

* Comment:

## Question 3

```{r q3_cleaning_covar}
q3_factor_order = c(
  "less than high school",
  "high school equivalent",
  "more than high school"
)

covar_df = 
  read_csv("Data/nhanes_covar.csv",skip = 4) |> 
  janitor::clean_names() |> 
  mutate(sex = recode(sex, '1' = 'male', '2' = 'female')) |> 
  mutate(education = case_match(education,
                                1~"less than high school",
                                2~"high school equivalent",
                                3~"more than high school")) |> 
  filter(age>=21) |> 
  drop_na() |> 
  mutate(education = factor(education,
                            levels = q3_factor_order,
                            ordered = TRUE)) |> 
  relocate(seqn,sex,education)
```
First of all, to make the code much more clear, I made a list of the education factor with the order. Then, I encoded the variable with reasonable classes as you can see in the code, and dropped all the `NA` in the data. To meet up the requirement, I also used the `filter` function to select the observations which is `21+`.

```{r cleaning_accel,warning=FALSE}
accel_df = 
  read_csv("Data/nhanes_accel.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(min1:min1440,
               names_to = "time_mark",
               values_to = "values") |> 
  mutate(time_mark = substring(time_mark,first = 4),
         time_mark = as.numeric(time_mark),) 
```

Then, I also cleaned the `nhanes_accel.csv`. Using the `clean_names` as usual, I convert all the uppercase letters within the names of variables into lowercase. After that, I convert the data into longer format and clean the characters `min` in all the `time_mark` classes to make it into a reader-friendly data frame.

```{r q3_table_for_each_catergory}
catergoried_mw_edu = covar_df |> 
  group_by(sex, education) |> 
  tally() |> 
  pivot_wider(
    names_from = sex,
    values_from = n
  ) |> knitr::kable(
    caption = "Summary of the total muber of people")

print(catergoried_mw_edu)
```

As you can see from the table above

```{r plot}
covar_df |> 
  ggplot(aes(x = education,y = age,color = sex))+
  geom_boxplot() +
  labs(title ="Boxplot of age distribution catergoried by sex and education" )
```

*Comments: 

```{r}
total_activity_df = accel_df |> 
  group_by(seqn) |> 
  summarise(total_activity = sum(values))

joint_sum_df = left_join(covar_df,total_activity_df,by = "seqn")

joint_sum_df |> 
  ggplot(aes(x = age , y = total_activity, color = sex, se = TRUE))+
  geom_point()+
  geom_smooth()+
  facet_grid(.~education)+
  labs(title = "")
```

*Comments: It's clear that the graph mainly shows the difference between three different education levels. In the graph of `less than high school`, females' total activity is higher than male before the age of 40. After that, female's total activity will drop faster than males did.  While in the graph of `high school equivalent` and the graph of `more than high school`, the females' total activity is higher than males nearly at all ages and they peaks ar the age of 48 in both sex groups. Above three graphs, they all showed a downward trend in both male and female group, in other words, as they became older, the total activity will drop gradually. 


```{r}

minutes = left_join(covar_df,accel_df,by = join_by("seqn")) 

minutes |>
  ggplot(aes(x = time_mark, y = values, color = sex)) +
  geom_line(alpha = 0.5) +
  geom_smooth(aes(group = sex), se = FALSE) +
  facet_wrap(~ education) +
  labs(x = "Time(minutes) in a Day", y = "MIMS") 
```


